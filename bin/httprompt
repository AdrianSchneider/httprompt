#!/usr/bin/env node
'use strict';

var program   = require('commander');
var path      = require('path');
var bootstrap = require('../src/bootstrap');
var Config    = require('../src/config');
var npmconfig = require('../package.json');

program
  .version(npmconfig.version)
  .option('-p --profile [value]', 'Start with profile')
  .option('-c --config [file]', 'Config filename')
  .parse(process.argv);

if (!program.profile) program.profile = 'default';
if (!program.config)  program.config = path.resolve(process.env.HOME, './.httprompt.json');

var config = new Config(program.config);
config.load(function(err) {
  if (err) die(err);

  bootstrap(config, process.stdin, process.stdout, program.profile, function(err, prompt) {
    if (err) die(err);
    var rl = prompt.start();

    rl.on('SIGINT', closeGracefully);
  });
});

var closeGracefully = function() {
  config.save(function() {
    process.exit(0);
  });
};

var die = function(err) {
  console.error(err);
  process.exit(1);
};
